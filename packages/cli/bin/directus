#!/usr/bin/env node

const devMode = require('fs').existsSync(`${__dirname}/../src`);
const wantsCompiled = process.argv.indexOf('--compiled-build') >= 0;

async function main(run) {
	const debug = require('debug')('directus-cli');
	try {
		const { error, output } = await run(process.argv);
		if (error) {
			debug(error);
		}

		if (output) {
			await output.flush(process.stdout);
		}

		process.exit(error ? 1 : 0);
	} catch (error) {
		console.error(error);
		process.exit(1);
	}
}

let run = () => {};
if (wantsCompiled || !devMode) {
	run = require(`${__dirname}/../dist/index`).default;
} else {
	process.env.DEBUG = `${process.env.DEBUG ?? ''}directus-cli`;
	require('ts-node').register({ project: `${__dirname}/../tsconfig.json` });
	run = require(`${__dirname}/../src/index`).default;
}

main(run);
